<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Event Details - FestiGo</title>
    <link rel="stylesheet" href="css/navbar.css" />
    <link rel="stylesheet" href="css/home.css" />
    <style>
      .detail-container {
        max-width: 900px;
        margin: 2rem auto;
        padding: 0 1rem;
      }
      .detail-card {
        background: rgba(255, 255, 255, 0.98);
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.25);
      }
      .detail-image {
        width: 100%;
        height: 350px;
        object-fit: cover;
      }
      .detail-content {
        padding: 2rem;
      }
      .detail-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        flex-wrap: wrap;
        gap: 1rem;
        margin-bottom: 1.5rem;
      }
      .detail-title {
        font-size: 2rem;
        font-weight: 700;
        color: #1f2937;
        margin: 0;
      }
      .detail-badges {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
      }
      .badge {
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 600;
      }
      .badge-genre {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
      }
      .badge-type {
        background: #e0e7ff;
        color: #4338ca;
      }
      .badge-seats {
        background: #dcfce7;
        color: #166534;
      }
      .badge-full {
        background: #fee2e2;
        color: #dc2626;
      }
      .badge-past {
        background: #fef3c7;
        color: #92400e;
      }
      .detail-meta {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
        padding: 1.5rem;
        background: #f8fafc;
        border-radius: 12px;
      }
      .meta-item {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .meta-icon {
        font-size: 1.5rem;
      }
      .meta-label {
        font-size: 12px;
        color: #6b7280;
        text-transform: uppercase;
      }
      .meta-value {
        font-size: 16px;
        color: #1f2937;
        font-weight: 600;
      }
      .detail-description {
        margin-bottom: 2rem;
      }
      .detail-description h3 {
        color: #1f2937;
        margin-bottom: 0.75rem;
      }
      .detail-description p {
        color: #4b5563;
        line-height: 1.7;
      }
      .booking-section {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 2rem;
        border-radius: 12px;
        color: white;
        text-align: center;
      }
      .booking-section h3 {
        margin-bottom: 1rem;
      }
      .booking-section p {
        margin-bottom: 1.5rem;
        opacity: 0.9;
      }
      .btn-book {
        padding: 14px 40px;
        background: white;
        color: #667eea;
        border: none;
        border-radius: 10px;
        font-size: 16px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.2s;
      }
      .btn-book:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
      }
      .btn-book:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }
      .btn-booked {
        background: #4ade80;
        color: white;
      }

      /* Payment Modal */
      .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s;
      }
      .modal-overlay.active {
        opacity: 1;
        visibility: visible;
      }
      .modal {
        background: white;
        border-radius: 16px;
        padding: 2rem;
        width: 90%;
        max-width: 450px;
        transform: scale(0.9);
        transition: transform 0.3s;
      }
      .modal-overlay.active .modal {
        transform: scale(1);
      }
      .modal-header {
        text-align: center;
        margin-bottom: 1.5rem;
      }
      .modal-header h2 {
        color: #1f2937;
        margin-bottom: 0.5rem;
      }
      .modal-header p {
        color: #6b7280;
        font-size: 14px;
      }
      .payment-form .form-group {
        margin-bottom: 1rem;
      }
      .payment-form label {
        display: block;
        font-size: 13px;
        color: #374151;
        margin-bottom: 4px;
        font-weight: 500;
      }
      .payment-form input {
        width: 100%;
        padding: 12px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 14px;
      }
      .payment-form input:focus {
        outline: none;
        border-color: #667eea;
      }
      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
      }
      .payment-total {
        display: flex;
        justify-content: space-between;
        padding: 1rem 0;
        border-top: 2px solid #e5e7eb;
        margin-top: 1rem;
        font-weight: 700;
        font-size: 18px;
      }
      .btn-pay {
        width: 100%;
        padding: 14px;
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        margin-top: 1rem;
        transition: all 0.2s;
      }
      .btn-pay:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
      }
      .btn-cancel {
        width: 100%;
        padding: 12px;
        background: #f3f4f6;
        color: #374151;
        border: none;
        border-radius: 10px;
        font-size: 14px;
        cursor: pointer;
        margin-top: 0.5rem;
      }

      /* Success Modal */
      .success-content {
        text-align: center;
        padding: 2rem;
      }
      .success-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
      }
      .success-content h2 {
        color: #059669;
        margin-bottom: 0.5rem;
      }
      .success-content p {
        color: #6b7280;
        margin-bottom: 1.5rem;
      }

      .loading-spinner {
        text-align: center;
        padding: 4rem;
        color: white;
      }
      .error-state {
        text-align: center;
        padding: 4rem;
        color: white;
      }
      .error-state h3 {
        margin-bottom: 1rem;
      }
      .error-state a {
        color: #4ade80;
      }

      @media (max-width: 600px) {
        .detail-image {
          height: 200px;
        }
        .detail-header {
          flex-direction: column;
        }
        .detail-title {
          font-size: 1.5rem;
        }
      }
    </style>
  </head>
  <body id="vanta-bg">
    <nav class="navbar">
      <div class="nav-container">
        <div class="logo">FestiGo</div>
        <ul class="nav-menu">
          <li><a href="/DBMS-mini-main/dashboard.html">Dashboard</a></li>
          <li><a href="/DBMS-mini-main/events.html">Events</a></li>
          <li id="navCreateEvent" style="display: none">
            <a href="/DBMS-mini-main/create-event.html">Create Event</a>
          </li>
          <li><a href="/DBMS-mini-main/bookings.html">My Bookings</a></li>
          <li><a href="/DBMS-mini-main/profile.html">Profile</a></li>
          <li><a href="#" id="logoutLink">Logout</a></li>
        </ul>
        <div class="hamburger" id="hamburger">
          <span></span><span></span><span></span>
        </div>
      </div>
    </nav>

    <main class="main-content">
      <div id="loadingState" class="loading-spinner">
        <p>Loading event details...</p>
      </div>
      <div id="errorState" class="error-state" style="display: none">
        <h3>Event not found</h3>
        <p><a href="/DBMS-mini-main/events.html">Browse all events</a></p>
      </div>
      <div id="detailContainer" class="detail-container" style="display: none">
        <div class="detail-card">
          <img id="eventImage" class="detail-image" src="" alt="" />
          <div class="detail-content">
            <div class="detail-header">
              <h1 id="eventTitle" class="detail-title"></h1>
              <div class="detail-badges" id="eventBadges"></div>
            </div>

            <div class="detail-meta">
              <div class="meta-item">
                <span class="meta-icon">üìÖ</span>
                <div>
                  <div class="meta-label">Date</div>
                  <div class="meta-value" id="eventDate">-</div>
                </div>
              </div>
              <div class="meta-item">
                <span class="meta-icon">‚è∞</span>
                <div>
                  <div class="meta-label">Time</div>
                  <div class="meta-value" id="eventTime">-</div>
                </div>
              </div>
              <div class="meta-item">
                <span class="meta-icon">üìç</span>
                <div>
                  <div class="meta-label">Location</div>
                  <div class="meta-value" id="eventLocation">-</div>
                </div>
              </div>
              <div class="meta-item">
                <span class="meta-icon">üë•</span>
                <div>
                  <div class="meta-label">Attendees</div>
                  <div class="meta-value" id="eventAttendees">-</div>
                </div>
              </div>
            </div>

            <div class="detail-description">
              <h3>About this Event</h3>
              <p id="eventDescription">-</p>
            </div>

            <div class="booking-section" id="bookingSection">
              <h3>Ready to attend?</h3>
              <p id="bookingMessage">Secure your spot at this amazing event!</p>
              <button
                class="btn-book"
                id="btnBook"
                onclick="openPaymentModal()"
              >
                Book Ticket
              </button>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Payment Modal -->
    <div class="modal-overlay" id="paymentModal">
      <div class="modal">
        <div class="modal-header">
          <h2>Payment Details</h2>
          <p>Complete your booking (Demo - No real payment)</p>
        </div>
        <form class="payment-form" id="paymentForm">
          <div class="form-group">
            <label>Card Number</label>
            <input
              type="text"
              placeholder="4242 4242 4242 4242"
              maxlength="19"
              required
            />
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Expiry Date</label>
              <input type="text" placeholder="MM/YY" maxlength="5" required />
            </div>
            <div class="form-group">
              <label>CVV</label>
              <input type="text" placeholder="123" maxlength="3" required />
            </div>
          </div>
          <div class="form-group">
            <label>Cardholder Name</label>
            <input type="text" placeholder="John Doe" required />
          </div>
          <div class="payment-total">
            <span>Total</span>
            <span>‚Çπ499.00</span>
          </div>
          <button type="submit" class="btn-pay">Pay & Book</button>
          <button
            type="button"
            class="btn-cancel"
            onclick="closePaymentModal()"
          >
            Cancel
          </button>
        </form>
      </div>
    </div>

    <!-- Success Modal -->
    <div class="modal-overlay" id="successModal">
      <div class="modal">
        <div class="success-content">
          <div class="success-icon">üéâ</div>
          <h2>Booking Confirmed!</h2>
          <p>
            Your ticket has been booked successfully. You will receive a
            confirmation email shortly.
          </p>
          <button
            class="btn-pay"
            onclick="window.location.href = '/DBMS-mini-main/bookings.html'"
          >
            View My Bookings
          </button>
          <button class="btn-cancel" onclick="closeSuccessModal()">
            Continue Browsing
          </button>
        </div>
      </div>
    </div>

    <footer class="site-footer">
      <div class="footer-content">
        <span>¬© 2026 FestiGo</span>
        <a href="#">About</a>
        <a href="#">Contact</a>
      </div>
    </footer>

    <script src="js/main.js"></script>
    <script src="js/nav.js"></script>
    <script>
      const API_BASE = (window.__ENV && window.__ENV.API_BASE_URL) || "/api";
      let currentEvent = null;
      let isBooked = false;

      function getAuth() {
        try {
          return JSON.parse(localStorage.getItem("auth"));
        } catch {
          return null;
        }
      }

      function formatDate(dateStr) {
        if (!dateStr) return "TBD";
        const date = new Date(dateStr);
        return date.toLocaleDateString("en-US", {
          weekday: "long",
          year: "numeric",
          month: "long",
          day: "numeric",
        });
      }

      function formatTime(timeStr) {
        if (!timeStr) return "TBD";
        const [hours, minutes] = timeStr.split(":");
        const h = parseInt(hours);
        const ampm = h >= 12 ? "PM" : "AM";
        return `${h % 12 || 12}:${minutes} ${ampm}`;
      }

      function isEventPast(event) {
        if (!event.date) return false;
        const eventDate = new Date(event.date);
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        return eventDate < today;
      }

      function isEventFull(event) {
        if (!event.maxCapacity) return false;
        return event.attendeesCount >= event.maxCapacity;
      }

      async function loadEventDetails() {
        const urlParams = new URLSearchParams(window.location.search);
        const eventId = urlParams.get("id");

        if (!eventId) {
          showError();
          return;
        }

        try {
          const resp = await fetch(`${API_BASE}/fests/${eventId}`);
          if (!resp.ok) throw new Error("Event not found");

          currentEvent = await resp.json();
          renderEvent(currentEvent);
        } catch (err) {
          console.error("Load event error:", err);
          showError();
        }
      }

      function showError() {
        document.getElementById("loadingState").style.display = "none";
        document.getElementById("errorState").style.display = "block";
      }

      function renderEvent(event) {
        document.getElementById("loadingState").style.display = "none";
        document.getElementById("detailContainer").style.display = "block";

        const defaultImage =
          "https://images.unsplash.com/photo-1501281668745-f7f57925c3b4?w=800&h=400&fit=crop";
        document.getElementById("eventImage").src =
          event.imageUrl || defaultImage;
        document.getElementById("eventImage").alt = event.name;
        document.getElementById("eventTitle").textContent = event.name;
        document.getElementById("eventDate").textContent = formatDate(
          event.date,
        );
        document.getElementById("eventTime").textContent = formatTime(
          event.time,
        );

        const location =
          [event.place, event.city, event.state].filter(Boolean).join(", ") ||
          "Location TBD";
        document.getElementById("eventLocation").textContent = location;

        // Attendees & Capacity
        let attendeesText = event.attendeesCount || 0;
        if (event.maxCapacity) {
          attendeesText = `${event.attendeesCount || 0} / ${event.maxCapacity}`;
        }
        document.getElementById("eventAttendees").textContent = attendeesText;

        document.getElementById("eventDescription").textContent =
          event.description || "No description available.";

        // Badges
        const badgesContainer = document.getElementById("eventBadges");
        badgesContainer.innerHTML = "";
        if (event.genre) {
          badgesContainer.innerHTML += `<span class="badge badge-genre">${event.genre}</span>`;
        }
        if (event.type) {
          badgesContainer.innerHTML += `<span class="badge badge-type">${event.type}</span>`;
        }

        // Check if event is past or full
        const isPast = isEventPast(event);
        const isFull = isEventFull(event);
        const btnBook = document.getElementById("btnBook");
        const bookingMessage = document.getElementById("bookingMessage");

        if (isPast) {
          badgesContainer.innerHTML += `<span class="badge badge-past">Event Ended</span>`;
          btnBook.textContent = "Event Has Ended";
          btnBook.disabled = true;
          bookingMessage.textContent = "This event has already taken place.";
        } else if (isFull) {
          badgesContainer.innerHTML += `<span class="badge badge-full">Sold Out</span>`;
          btnBook.textContent = "Sold Out";
          btnBook.disabled = true;
          bookingMessage.textContent = "Sorry, this event is fully booked.";
        } else {
          const seatsLeft = event.maxCapacity
            ? event.maxCapacity - (event.attendeesCount || 0)
            : null;
          if (seatsLeft !== null && seatsLeft <= 10) {
            badgesContainer.innerHTML += `<span class="badge badge-seats">Only ${seatsLeft} left!</span>`;
          } else if (seatsLeft !== null) {
            badgesContainer.innerHTML += `<span class="badge badge-seats">${seatsLeft} seats available</span>`;
          }
        }

        // Check if user already booked
        checkIfBooked(event.id);
      }

      async function checkIfBooked(eventId) {
        const auth = getAuth();
        if (!auth || !auth.id) return;

        try {
          const resp = await fetch(`${API_BASE}/users/${auth.id}/bookings`);
          if (!resp.ok) return;
          const bookings = await resp.json();
          isBooked = bookings.some((b) => b.festId === eventId);

          if (isBooked) {
            const btnBook = document.getElementById("btnBook");
            btnBook.textContent = "‚úì Already Booked";
            btnBook.classList.add("btn-booked");
            btnBook.disabled = true;
            document.getElementById("bookingMessage").textContent =
              "You have already booked this event!";
          }
        } catch (err) {
          console.log("Could not check booking status");
        }
      }

      function openPaymentModal() {
        const auth = getAuth();
        if (!auth || !auth.id) {
          window.location.href = `/DBMS-mini-main/login.html?next=${encodeURIComponent(window.location.pathname + window.location.search)}`;
          return;
        }
        document.getElementById("paymentModal").classList.add("active");
      }

      function closePaymentModal() {
        document.getElementById("paymentModal").classList.remove("active");
      }

      function closeSuccessModal() {
        document.getElementById("successModal").classList.remove("active");
      }

      document
        .getElementById("paymentForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const auth = getAuth();
          if (!auth || !auth.id || !currentEvent) return;

          // Simulate payment processing
          const btn = this.querySelector(".btn-pay");
          btn.textContent = "Processing...";
          btn.disabled = true;

          try {
            // Call the attend API
            const resp = await fetch(
              `${API_BASE}/fests/${currentEvent.id}/attend`,
              {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ userId: auth.id }),
              },
            );

            if (!resp.ok) {
              const msg = await resp.text().catch(() => "Booking failed");
              throw new Error(msg);
            }

            // Success!
            closePaymentModal();
            document.getElementById("successModal").classList.add("active");

            // Update button state
            const btnBook = document.getElementById("btnBook");
            btnBook.textContent = "‚úì Booked";
            btnBook.classList.add("btn-booked");
            btnBook.disabled = true;
            document.getElementById("bookingMessage").textContent =
              "You have booked this event!";
          } catch (err) {
            console.error("Booking error:", err);
            alert(err.message || "Booking failed. Please try again.");
          } finally {
            btn.textContent = "Pay & Book";
            btn.disabled = false;
          }
        });

      loadEventDetails();
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.fog.min.js"></script>
    <script>
      VANTA.FOG({
        el: "#vanta-bg",
        mouseControls: true,
        touchControls: true,
        gyroControls: false,
        minHeight: 200,
        minWidth: 200,
        highlightColor: 0x12ff,
        midtoneColor: 0xe03922,
        baseColor: 0xbe7df2,
      });
    </script>
  </body>
</html>
